#!/bin/bash

# Git Pre-Commit Hook to Prevent Secret Leaks
# This hook scans staged files for potential secrets before committing

echo "üîç Scanning for secrets before commit..."

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Flag to track if secrets were found
SECRETS_FOUND=false

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}‚úÖ No staged files to scan${NC}"
    exit 0
fi

echo "üìÅ Scanning staged files:"
echo "$STAGED_FILES"
echo ""

# Secret patterns to detect
declare -A PATTERNS=(
    # Google API Keys
    ["Google API Key"]="AIza[0-9A-Za-z_-]{35}"

    # AWS Keys
    ["AWS Access Key"]="AKIA[0-9A-Z]{16}"
    ["AWS Secret Key"]="[0-9a-zA-Z/+]{40}"

    # Generic API Keys
    ["Generic API Key"]="[aA][pP][iI]_?[kK][eE][yY].*['\"][0-9a-zA-Z]{32,}['\"]"

    # Tokens
    ["JWT Token"]="eyJ[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*"
    ["Generic Token"]="[tT][oO][kK][eE][nN].*['\"][0-9a-zA-Z]{32,}['\"]"

    # Database URLs
    ["Database URL"]="(postgres|mysql|mongodb)://[^\s'\"]*"

    # Private Keys
    ["Private Key"]="-----BEGIN [A-Z ]*PRIVATE KEY-----"

    # Passwords in code
    ["Password"]="[pP][aA][sS][sS][wW][oO][rR][dD].*['\"][^'\"]{8,}['\"]"

    # Supabase Keys (anon key is OK, service role is not)
    ["Supabase Service Role"]="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\.[^.]*\..*service_role.*"

    # GitHub Tokens
    ["GitHub Token"]="gh[pousr]_[A-Za-z0-9_]{36,255}"

    # Stripe Keys
    ["Stripe Secret Key"]="sk_[a-z]*_[A-Za-z0-9]{24,}"
    ["Stripe Publishable Key"]="pk_[a-z]*_[A-Za-z0-9]{24,}"

    # OpenAI Keys
    ["OpenAI API Key"]="sk-[A-Za-z0-9]{48,}"

    # Anthropic Keys
    ["Anthropic API Key"]="sk-ant-api03-[A-Za-z0-9_-]{95,}"
)

# Exception patterns (these are OK to commit)
EXCEPTIONS=(
    # Placeholder values
    "YOUR_.*_KEY_HERE"
    "YOUR_.*_TOKEN_HERE"
    "REPLACE_WITH_"
    "EXAMPLE_"
    "DEMO_"

    # Test/Mock values
    "test[_-].*key"
    "mock[_-].*key"
    "fake[_-].*key"

    # Documentation examples
    "AIzaSyBX5y8P2dE8-1MqF3CqDXO_K3UPMFNpJ_M"  # Example key from old docs

    # Environment variable references (not actual secrets)
    "process\.env\."
    "Deno\.env\.get"
    "\$\{.*\}"

    # Comments about secrets
    "# This is a public API key"
    "// Public API key"
    "Replace with your actual"
)

# Function to check if a match is an exception
is_exception() {
    local match="$1"
    for exception in "${EXCEPTIONS[@]}"; do
        if echo "$match" | grep -qE "$exception"; then
            return 0
        fi
    done
    return 1
}

# Scan each staged file
for file in $STAGED_FILES; do
    # Skip binary files
    if file "$file" | grep -q "binary"; then
        continue
    fi

    # Skip if file doesn't exist (deleted files)
    if [ ! -f "$file" ]; then
        continue
    fi

    echo "üîç Scanning: $file"

    # Check each pattern
    for pattern_name in "${!PATTERNS[@]}"; do
        pattern="${PATTERNS[$pattern_name]}"

        # Search for pattern in file
        matches=$(git diff --cached "$file" | grep -E "^\+" | grep -oE "$pattern" || true)

        if [ -n "$matches" ]; then
            # Check each match against exceptions
            while IFS= read -r match; do
                if [ -n "$match" ] && ! is_exception "$match"; then
                    echo "${RED}‚ùå POTENTIAL SECRET DETECTED${NC}"
                    echo "   File: $file"
                    echo "   Type: $pattern_name"
                    echo "   Pattern: ${match:0:20}..."
                    echo ""
                    SECRETS_FOUND=true
                fi
            done <<< "$matches"
        fi
    done
done

# Final result
if [ "$SECRETS_FOUND" = true ]; then
    echo ""
    echo "${RED}üö® COMMIT BLOCKED: Potential secrets detected!${NC}"
    echo ""
    echo "${YELLOW}How to fix:${NC}"
    echo "1. Remove the secret from your code"
    echo "2. Use environment variables instead"
    echo "3. Add to .gitignore if it's a config file"
    echo "4. Use placeholder values in documentation"
    echo ""
    echo "${YELLOW}If this is a false positive:${NC}"
    echo "1. Check the exception patterns in .githooks/pre-commit"
    echo "2. Add your pattern to the EXCEPTIONS array"
    echo "3. Use --no-verify to bypass (NOT recommended)"
    echo ""
    exit 1
else
    echo "${GREEN}‚úÖ No secrets detected - commit approved!${NC}"
    exit 0
fi