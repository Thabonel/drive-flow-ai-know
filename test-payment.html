<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment System Test - AI Query Hub</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #5469d4;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #4053b8;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      background: #f0f0f0;
      border-radius: 6px;
      font-family: monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    h2 {
      margin-top: 0;
      color: #333;
    }
    .info {
      background: #cce5ff;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    .test-card {
      background: #fff3cd;
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
    }
    input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 300px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>🧪 AI Query Hub - Payment System Test</h1>

  <div class="info">
    <strong>Testing Environment:</strong> Stripe Test Mode<br>
    <strong>Supabase URL:</strong> https://fskwutnoxbbflzqrphro.supabase.co<br>
    <strong>Status:</strong> <span id="auth-status">Checking authentication...</span>
  </div>

  <div class="test-card">
    <strong>Stripe Test Card:</strong> 4242 4242 4242 4242<br>
    <strong>Expiry:</strong> Any future date (e.g., 12/34)<br>
    <strong>CVC:</strong> Any 3 digits (e.g., 123)
  </div>

  <!-- Test 1: Authentication -->
  <div class="test-section">
    <h2>Test 1: User Authentication</h2>
    <p>Enter your login credentials to test payment flow:</p>
    <div>
      <input type="email" id="email" placeholder="Email" value="">
      <input type="password" id="password" placeholder="Password" value="">
    </div>
    <button onclick="testAuth()">Login</button>
    <div id="auth-result" class="result" style="display:none;"></div>
  </div>

  <!-- Test 2: Create Subscription -->
  <div class="test-section">
    <h2>Test 2: Create Subscription (14-day trial)</h2>
    <p>Test subscription creation and Stripe checkout redirect:</p>
    <button onclick="testSubscription('starter')" id="starter-btn" disabled>
      Test Starter ($9/month)
    </button>
    <button onclick="testSubscription('pro')" id="pro-btn" disabled>
      Test Pro ($45/month)
    </button>
    <button onclick="testSubscription('business')" id="business-btn" disabled>
      Test Business ($150/month)
    </button>
    <div id="subscription-result" class="result" style="display:none;"></div>
  </div>

  <!-- Test 3: Rate Limiting -->
  <div class="test-section">
    <h2>Test 3: Rate Limiting (100 queries/hour)</h2>
    <p>Send multiple queries rapidly to test rate limiting:</p>
    <button onclick="testRateLimit()" id="rate-btn" disabled>
      Send 10 Test Queries
    </button>
    <div id="rate-result" class="result" style="display:none;"></div>
  </div>

  <!-- Test 4: Webhook Verification -->
  <div class="test-section">
    <h2>Test 4: Webhook Status</h2>
    <p>Check if Stripe webhooks are configured correctly:</p>
    <button onclick="checkWebhook()">Check Webhook Setup</button>
    <div id="webhook-result" class="result" style="display:none;"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://fskwutnoxbbflzqrphro.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZza3d1dG5veGJiZmx6cXJwaHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjg2NzAyNjQsImV4cCI6MjA0NDI0NjI2NH0.T8UY3mMLZLnUVHNjNxnN8L04P1ohRJGKp-nFvZOxj6I';

    const STRIPE_PRICE_IDS = {
      starter: 'price_1SJ242DXysaVZSVh4s8X7pQX',
      pro: 'price_1SJ24pDXysaVZSVhjWh5Z9dk',
      business: 'price_1SJ25YDXysaVZSVhyjwdk3HN',
    };

    let authToken = null;
    let userId = null;

    function showResult(elementId, content, isSuccess = false) {
      const el = document.getElementById(elementId);
      el.style.display = 'block';
      el.className = isSuccess ? 'result success' : (content.includes('Error') ? 'result error' : 'result');
      el.innerHTML = typeof content === 'string' ? content : JSON.stringify(content, null, 2);
    }

    async function testAuth() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showResult('auth-result', 'Error: Please enter email and password');
        return;
      }

      try {
        const response = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (data.access_token) {
          authToken = data.access_token;
          userId = data.user.id;

          showResult('auth-result', `✅ Authentication successful!\n\nUser ID: ${userId}\nEmail: ${email}`, true);

          // Enable other test buttons
          document.getElementById('starter-btn').disabled = false;
          document.getElementById('pro-btn').disabled = false;
          document.getElementById('business-btn').disabled = false;
          document.getElementById('rate-btn').disabled = false;

          document.getElementById('auth-status').textContent = `✅ Authenticated as ${email}`;
          document.getElementById('auth-status').style.color = 'green';
        } else {
          showResult('auth-result', `Error: ${data.error_description || data.msg || 'Authentication failed'}`);
        }
      } catch (error) {
        showResult('auth-result', `Error: ${error.message}`);
      }
    }

    async function testSubscription(planType) {
      if (!authToken) {
        showResult('subscription-result', 'Error: Please login first');
        return;
      }

      const priceId = STRIPE_PRICE_IDS[planType];

      try {
        showResult('subscription-result', `Creating ${planType} subscription...\nPrice ID: ${priceId}`);

        const response = await fetch(`${SUPABASE_URL}/functions/v1/create-subscription`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ priceId, planType })
        });

        const data = await response.json();

        if (data.url) {
          showResult('subscription-result',
            `✅ Subscription created successfully!\n\nCheckout URL:\n${data.url}\n\nOpening Stripe Checkout in 3 seconds...`,
            true
          );

          setTimeout(() => {
            window.open(data.url, '_blank');
          }, 3000);
        } else {
          showResult('subscription-result', `Error: ${data.error || 'Failed to create subscription'}`);
        }
      } catch (error) {
        showResult('subscription-result', `Error: ${error.message}`);
      }
    }

    async function testRateLimit() {
      if (!authToken) {
        showResult('rate-result', 'Error: Please login first');
        return;
      }

      showResult('rate-result', 'Sending 10 test queries rapidly...\n\n');
      const results = [];

      for (let i = 1; i <= 10; i++) {
        try {
          const response = await fetch(`${SUPABASE_URL}/functions/v1/ai-query`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`,
              'apikey': SUPABASE_ANON_KEY
            },
            body: JSON.stringify({
              query: `Test query #${i} - ${new Date().toISOString()}`
            })
          });

          const data = await response.json();

          if (response.status === 429) {
            results.push(`Query ${i}: ❌ RATE LIMITED (as expected!)\n  Queries this hour: ${data.queries_this_hour}`);
            showResult('rate-result', results.join('\n\n'), false);
            break;
          } else {
            results.push(`Query ${i}: ✅ Success (${response.status})`);
          }
        } catch (error) {
          results.push(`Query ${i}: ❌ Error: ${error.message}`);
        }

        showResult('rate-result', results.join('\n\n'));
        await new Promise(resolve => setTimeout(resolve, 100)); // Small delay
      }
    }

    function checkWebhook() {
      showResult('webhook-result',
        `Webhook Endpoint:\nhttps://fskwutnoxbbflzqrphro.supabase.co/functions/v1/stripe-webhook\n\n` +
        `✅ Configure this in Stripe Dashboard:\n` +
        `https://dashboard.stripe.com/test/webhooks\n\n` +
        `Events to listen for:\n` +
        `• customer.subscription.created\n` +
        `• customer.subscription.updated\n` +
        `• customer.subscription.deleted\n` +
        `• invoice.payment_succeeded\n` +
        `• invoice.payment_failed\n\n` +
        `Your webhook secret should match:\neb959f8a40fb57f2839...`,
        true
      );
    }

    // Check auth status on load
    window.onload = () => {
      document.getElementById('auth-status').textContent = '❌ Not authenticated';
      document.getElementById('auth-status').style.color = 'red';
    };
  </script>
</body>
</html>
